<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Set Game</title>
    <style>
        .grid-container-box {
            border: 2px solid #f0f0f0;; /* Add a border with black color */
            border-bottom: none; /* Remove bottom border */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* Shadow effect on bottom */
            padding: 10px; /* Add padding to create space between the border and the grid */
            max-width: 600px; /* Optionally, set a maximum width for the container */
            margin: 0 auto; /* Center the container horizontally */
            border-radius: 10px; /* Rounded corners */
        }
        .grid-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        .grid-item img {
            width: 100%;
            height: auto;
            border: 2px solid gray; /* Add a gray border */
            border-radius: 5px; /* Optionally, add border radius for rounded corners */
        }
        .grid-item img.selected {
            border-color: purple; /* Change border color to indicate selection */
            box-shadow: 0 0 10px rgba(0, 0, 0, 1.0); /* Add shadow effect */
        }
		.attributes-hidden {
			display: none; /* Hide the container */
		}
    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        var selectedCount = 0; // Variable to keep track of selected cards count
		var setCount = 0; // Variable to keep track of set count
        function toggleSelection(event) {
            event.preventDefault(); // Prevent the default link behavior
            event.stopPropagation(); // Prevent the event from bubbling up the DOM tree
            var image = event.target; // Get the clicked image element

            // Check if less than 3 images are selected or if the clicked image is already selected
            if (selectedCount < 3 || image.classList.contains('selected')) {
                // Toggle the 'selected' class on the clicked image
                image.classList.toggle('selected');
                // Update the selected count based on the current state of the clicked image
                selectedCount += image.classList.contains('selected') ? 1 : -1;

                // Check if the number of selected cards is 3
                if (selectedCount === 3) {
                    // Automatically check for a set
                    checkSet();
                }
            } else {
                alert("You can only select up to 3 images."); // Show an alert if trying to select more than 3 images
            }
        }function checkSet() {
    var selectedImages = document.querySelectorAll('.grid-item img.selected');
    if (selectedImages.length === 3) {
        var attributes = [];
        selectedImages.forEach(function(image) {
            attributes.push({
                color: image.dataset.color,
                number: image.dataset.number,
                shape: image.dataset.shape,
                shading: image.dataset.shading
            });
        });

        $.ajax({
            url: '/check_set',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(attributes),
			success: function(response) {
				if (response.message === 'set') {
					// Remove message box
					$('.message-box').remove();

					// Remove selected cards
					selectedImages.forEach(function(image) {
						image.parentNode.parentNode.remove();
					});
					selectedCount = 0;

					// Update set count
					updateSetCount();
                    // Fetch new random cards to replace the removed ones
                    $.ajax({
                        url: '/get_random_cards',
                        type: 'GET',
                        success: function(newCards) {
                            // Append the new cards to the grid container
                            var gridContainer = $('.grid-container');
                            newCards.forEach(function(card) {
                                var imageUrl = card.image_url;
                                var attributes = card.attributes;
                                var gridItem = $('<div class="grid-item"></div>');
                                var image = $('<img>').attr({
                                    src: "/static/images/" + imageUrl,
                                    alt: 'Image',
                                    'data-color': attributes['color'],
                                    'data-number': attributes['number'],
                                    'data-shape': attributes['shape'],
                                    'data-shading': attributes['shading']
                                }).on('click', function(event) {
                                    toggleSelection(event);
                                });
                                gridItem.append(image);
                                gridContainer.append(gridItem);
                            });
                            $('.grid-container-box').append(gridContainer);
                        }
                    });
                }
            },
            error: function(xhr, status, error) {
                console.error("AJAX request failed:", status, error);
            }
        });
    }
}

		function updateSetCount() {
			setCount++; // Increment set count by 1
			document.getElementById('set-count').textContent = 'Sets found: ' + setCount; // Update set count display
		}
    </script>
</head>
<body>
    <h1>Set Game</h1>
    <div class="grid-container-box">
        <div class="grid-container">
            {% for filename, attributes in random_images %}
            <div class="grid-item">
                <a href="#" onclick="toggleSelection(event)">
                    <img src="{{ url_for('static', filename='images/' + filename) }}" alt="Image"
                         data-color="{{ attributes.color }}"
                         data-number="{{ attributes.number }}"
                         data-shape="{{ attributes.shape }}"
                         data-shading="{{ attributes.shading }}">
                </a>
				<div class="attributes-hidden"> <!-- Container for hidden attributes -->
					<p>Number: {{ attributes.number }}</p>
					<p>Color: {{ attributes.color }}</p>
					<p>Shape: {{ attributes.shape }}</p>
					<p>Shading: {{ attributes.shading }}</p>
				</div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Stopwatch -->
    <div id="stopwatch">00:00:00</div>

    <!-- Include the JavaScript for the stopwatch -->
    <script>
        // Function to start the stopwatch
        function startStopwatch() {
            var startTime = Date.now(); // Get the current time in milliseconds

            // Update the stopwatch display every 100 milliseconds
            var intervalId = setInterval(function() {
                var elapsedTime = Date.now() - startTime; // Calculate elapsed time
                var hours = Math.floor(elapsedTime / (1000 * 60 * 60)); // Convert milliseconds to hours
                var minutes = Math.floor((elapsedTime % (1000 * 60 * 60)) / (1000 * 60)); // Convert milliseconds to minutes
                var seconds = Math.floor((elapsedTime % (1000 * 60)) / 1000); // Convert milliseconds to seconds

                // Format the time string (add leading zeros if necessary)
                var timeString = ('0' + hours).slice(-2) + ':' + ('0' + minutes).slice(-2) + ':' + ('0' + seconds).slice(-2);

                // Update the stopwatch display
                document.getElementById('stopwatch').textContent = timeString;
            }, 100); // Update every 100 milliseconds

            // Return the interval ID so it can be stopped later if needed
            return intervalId;
        }

        // Start the stopwatch when the page loads
        var intervalId = startStopwatch();
    </script>
	<div id="set-count">Sets found: 0</div> <!-- Add an element to display the set count -->
 
    <form method="GET" action="/">
        <button type="submit">Return to Home Page</button>
    </form>
</body>
</html>
